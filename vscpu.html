<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
		<title>Jugar contra la máquina</title>
		<link type="text/css" rel="stylesheet" href="css/reset.css">
		<link type="text/css" rel="stylesheet" href="css/mesajuego.css">
		<link type="text/css" rel="stylesheet" href="css/vscpu.css">
		<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
		<script type="text/javascript" src="js/IABrisca.js"></script>
	</head>
	<body>
		<div id="contenedor_vscpu">
			<div id="mensajeInicio">
				Elije el número de oponentes:<br>
				<div class="ico" onclick="iniciarPartidaBrisca_VSCPU(2)"><img src="/img/iconos/1.png"></div>
				<div class="ico" onclick="iniciarPartidaBrisca_VSCPU(3)"><img src="/img/iconos/2.png"></div>
				<div class="ico" onclick="iniciarPartidaBrisca_VSCPU(4)"><img src="/img/iconos/3.png"></div>
			</div>
		</div>
		<div id="contenedor" style="display:none;">
			<div id="mesa" style="width:100%;">
				<div id="todas_las_cartas">
					<!--llenar este div con todas las cartas desde js-->
				</div>
				
				<!--Posiciones. Para poder ver donde están-->
				<div id="posiciones">
					<!--cartas en mano-->
					<div id="P1C1"></div>
					<div id="P1C2"></div>
					<div id="P1C3"></div>
					<div id="P2C1"></div>
					<div id="P2C2"></div>
					<div id="P2C3"></div>
					<div id="P3C1"></div>
					<div id="P3C2"></div>
					<div id="P3C3"></div>
					<div id="P4C1"></div>
					<div id="P4C2"></div>
					<div id="P4C3"></div>
					
					<!--cartas ganadas-->
					<div id="P1C0"></div>
					<div id="P2C0"></div>
					<div id="P3C0"></div>
					<div id="P4C0"></div>
					
					<!--cartas palo que manda-->
					<div id="MC0"></div>
					
					<!--cartas en mesa-->
					<div id="MC1"></div>
					<div id="MC2"></div>
					<div id="MC3"></div>
					<div id="MC4"></div>
					
					<!--carta mazo-->
					<div id="MM"></div>
					
					<!--Marcador de puntos-->
					<div id="P1N"></div>
					<div id="P2N"></div>
					<div id="P3N"></div>
					<div id="P4N"></div>
				</div>
				
				<div id="mensaje_fin" class="off">
					HABDALA HABDALA
				</div>
				
			</div>
		</div>
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		<script type="text/javascript">
		
			
		
			/*window.onresize=function(){
				var height = window.innerHeight;
				var mesa = document.getElementById('mesa');
				var chat = document.getElementById('chat');
				mesa.style.height = height+"px";
				mesa.style.width = height+"px";
				chat.style.width = (window.innerWidth - height)+"px";
			};*/
			
			
			
			// Iniciar el script de la brisca
			function iniciarPartidaBrisca_VSCPU(cantidadJugadores){
				if(typeof cantidadJugadores === "undefined" || cantidadJugadores < 2 || cantidadJugadores > 4)
					return;
				
				document.getElementById("contenedor_vscpu").style.display = "none";
				document.getElementById("contenedor").style.display = "";
			
				IABriscaInstancia = new IABrisca();
				
				IABriscaInstancia.moverCarta = moverCarta;
				IABriscaInstancia.seteaPuntos = seteaPuntos;
				IABriscaInstancia.pideCartaHumano = pideCartaHumano;
				IABriscaInstancia.fin = fin;
				
				//IABriscaInstancia.console2.on = true;
			
		
		
		
				arrPosiciones = document.getElementById('posiciones').children;
				for(var i=0; i < arrPosiciones.length; ++i){
					arrPosiciones[i].innerHTML = "";
				}
				
				
				
				
				
				// Indicar el tamaño de las cartas mediante javascript editando el style
				// Tamaño de las cartas = 201 x 279
				// ratio = 201 / 279 = 0.72
				// ancho = alto * 0.72
				// alto = ancho / 0.72
				aspectRatio = 0.72;
				
				windowInnerWH = viewport();
				
				maximo = Math.min(windowInnerWH.height,windowInnerWH.width);
				if(maximo == windowInnerWH.height){
					widthCarta = maximo*0.17;
				}
				else{
					widthCarta = maximo*0.17*aspectRatio;
				}
				heightCarta = widthCarta/aspectRatio;
				widthCarta2 = widthCarta/2;
				heightCarta2 = heightCarta/2;
				maximoAzarDesfaseWidth = widthCarta * 0.02;
				maximoAzarDesfaseHeight = heightCarta * 0.02;
				maximoAzarDesgaseGrados = 2;
				
				todas_las_cartas = document.getElementById('todas_las_cartas');
				todas_las_cartas.innerHTML = "";
				mazo_cartas = document.getElementById('MM');
				arrCartas = IABriscaInstancia.IABriscaBaseInstancia.cartasTotalArray;
				for(var i in arrCartas){
					todas_las_cartas.innerHTML += '<img class="carta" style="position:absolute;width:'+widthCarta+'px;height:'+heightCarta+'px;top:'+(mazo_cartas.offsetTop -heightCarta2)+'px;left:'+(mazo_cartas.offsetLeft -widthCarta2)+'px;" id="carta_'+arrCartas[i]+'" src="img/cartas/back2.jpg">';
				}
				
				IABriscaInstancia.IABriscaMesaInstancia.iniciarMesa();
				
				
				//IABriscaInstancia.IABriscaMesaInstancia.tiempoEntreRondas = 0;
				//IABriscaInstancia.IABriscaMesaInstancia.tiempoRepartiendoCarta = 0;
				
				jugadores = [];
				
				switch(cantidadJugadores){
					case 2:
						jugadores[0] = new IABriscaInstancia.HumanoBriscaJugador();
						jugadores[0].iniciarJugador(1);
						jugadores[1] = new IABriscaInstancia.IABriscaJugador();
						jugadores[1].iniciarJugador(3);
						seteaPuntos('P1', 0);
						seteaPuntos('P3', 0);
						document.getElementById("P1N").style.display = "inherit";
						document.getElementById("P2N").style.display = "none";
						document.getElementById("P3N").style.display = "inherit";
						document.getElementById("P4N").style.display = "none";
					break;
					case 3:
						jugadores[0] = new IABriscaInstancia.HumanoBriscaJugador();
						jugadores[0].iniciarJugador(1);
						jugadores[1] = new IABriscaInstancia.IABriscaJugador();
						jugadores[1].iniciarJugador(2);
						jugadores[2] = new IABriscaInstancia.IABriscaJugador();
						jugadores[2].iniciarJugador(3);
						seteaPuntos('P1', 0);
						seteaPuntos('P2', 0);
						seteaPuntos('P3', 0);
						document.getElementById("P1N").style.display = "inherit";
						document.getElementById("P2N").style.display = "inherit";
						document.getElementById("P3N").style.display = "inherit";
						document.getElementById("P4N").style.display = "none";
					break;
					case 4:
						jugadores[0] = new IABriscaInstancia.HumanoBriscaJugador();
						jugadores[0].iniciarJugador(1);
						jugadores[1] = new IABriscaInstancia.IABriscaJugador();
						jugadores[1].iniciarJugador(2);
						jugadores[2] = new IABriscaInstancia.IABriscaJugador();
						jugadores[2].iniciarJugador(3);
						jugadores[3] = new IABriscaInstancia.IABriscaJugador();
						jugadores[3].iniciarJugador(4);
						seteaPuntos('P1', 0);
						seteaPuntos('P2', 0);
						seteaPuntos('P3', 0);
						seteaPuntos('P4', 0);
						document.getElementById("P1N").style.display = "inherit";
						document.getElementById("P2N").style.display = "inherit";
						document.getElementById("P3N").style.display = "inherit";
						document.getElementById("P4N").style.display = "inherit";
					break;
					default:
						return;
					break;
				}
				
				if(cantidadJugadores === 2){
					
				}
				else if(cantidadJugadores === 3){
					
				}
				else if(cantidadJugadores === 4){
					
				}
				else return;
				
				// Inserta jugadores y comienza
				IABriscaInstancia.IABriscaMesaInstancia.comienzaPartida(jugadores);
				
				
			}
			
			
			
			
			
			
			
			
			
			
			
			
			
			///////////////////////////////////////////////////
			//
			// FUNCIONES
			//
			///////////////////////////////////////////////////
			
			
			
			var zIndexTemp = 1;
			// Mover la carta a dónde
			function moverCartaA(carta, hasta){
				var cartaObj = document.getElementById('carta_'+carta);
				var hastaObj = document.getElementById(hasta);
				
				for(var i = 0; i < arrPosiciones.length; ++i){
					if(arrPosiciones[i].innerHTML.indexOf('{{'+carta+'}}') != -1){
						arrPosiciones[i].innerHTML = arrPosiciones[i].innerHTML.split('{{'+carta+'}}').join('');
					}
				}
				hastaObj.innerHTML += '{{'+carta+'}}';
				
				/*if(cartaObj.parentElement.id != 'todas_las_cartas_visible'){
					moverCartaDeA(carta, 'MM', hasta);
					return;
				}*/
				
				cartaObj.style.top = (hastaObj.offsetTop -heightCarta2 +((Math.random()*2) -1) *maximoAzarDesfaseWidth) +"px";
				cartaObj.style.left = (hastaObj.offsetLeft -widthCarta2 +((Math.random()*2) -1) *maximoAzarDesfaseHeight) +"px";
				if(hasta.indexOf("P2") != -1 || hasta.indexOf("P4") != -1){
					cartaObj.style.webkitTransform =
					cartaObj.style.mozTransform =
					cartaObj.style.msTransform =
					cartaObj.style.oTransform =
					cartaObj.style.transform = 'rotate('+(90 +((Math.random()*2) -1) *maximoAzarDesgaseGrados)+'deg)';
				}
				else{
					cartaObj.style.webkitTransform =
					cartaObj.style.mozTransform =
					cartaObj.style.msTransform =
					cartaObj.style.oTransform =
					cartaObj.style.transform = 'rotate('+(((Math.random()*2) -1) *maximoAzarDesgaseGrados)+'deg)';
				}
				cartaObj.style.zIndex = ++zIndexTemp;
			}
			
			// Mover la carta a dónde
			function moverCartaDeA(carta, desde, hasta){
				var cartaObj = document.getElementById('carta_'+carta);
				var desdeObj = document.getElementById(desde);
				/*if(cartaObj.parentElement.id != 'todas_las_cartas_visible'){
					document.getElementById('todas_las_cartas_visible').appendChild(cartaObj);
				}*/
				
				cartaObj.style.top = desdeObj.offsetTop -heightCarta2+"px";
				cartaObj.style.left = desdeObj.offsetLeft -widthCarta2+"px";
				setTimeout((function(carta, hasta){
					return function(){
						moverCartaA(carta, hasta);
					}
				})(carta, hasta), 0);
			}
			
			
			
			// Retorna el número, del 1 al 3, donde poner la carta a un jugador
			function huecoLibreJugador(jugadorID){
				for(var i = 1; i <= 3; ++i){
					if(document.getElementById('P'+jugadorID+'C'+i).innerHTML === ''){
						return i;
					}
				}
			}
			
			// Retorna el número, del 1 al 4, donde poner la carta en la mesa
			function huecoLibreMesa(){
				for(var i = 1; i <= 4; ++i){
					if(document.getElementById('MC'+i).innerHTML === ''){
						return i;
					}
				}
			}
			
			function moverCarta(carta, donde){
				if(donde.indexOf("P1")!=-1 || donde.indexOf("MC")!=-1 || donde.indexOf("C0")!=-1){
					document.getElementById('carta_'+carta).src = "/img/cartas/"+carta+".jpg";
				}
				else{
					document.getElementById('carta_'+carta).src = "/img/cartas/back2.jpg";
				}
				if(donde.indexOf("P")!=-1 || donde.indexOf("MC")!=-1 || donde.indexOf("C0")!=-1){
					if(donde.indexOf("MC")!=-1 && donde.indexOf("0",2)==-1){
						var huecoLibre = huecoLibreMesa();
						moverCartaA(carta, donde+huecoLibre);
					}
					else if(donde.indexOf("P")!=-1 && donde.indexOf("0",2)==-1){
						var huecoLibre = huecoLibreJugador(donde.substr(1, donde.length -1));
						moverCartaA(carta, donde+'C'+huecoLibre);
					}
					else{
						moverCartaA(carta, donde);
					}
				}
				else{
					moverCartaA(carta, donde);
				}
			}
			
			function pideCartaHumano(id, posiblesCartas, callback){
				for(var i in posiblesCartas){
					var id = 'carta_'+posiblesCartas[i];
					document.getElementById(id).style.cursor = 'pointer';
					document.getElementById(id).onclick = (function(i, callback, thisT){
						return function(){
							for(var z in posiblesCartas){
								document.getElementById('carta_'+posiblesCartas[z]).style.cursor = 'default';
								document.getElementById('carta_'+posiblesCartas[z]).onclick = function(){};
							}
							callback(posiblesCartas[i]);
						};
					})(i, callback);
				}
			}
			
			function fin(resultados){
				console.log(resultados);
				mensaje_fin = document.getElementById("mensaje_fin");
				mensaje_fin.className = "";
				
				var mensaje = "HAS GANADO";
				
				var misPuntos = resultados["1"];
				for(var i in resultados){
					if(i != "1"){
						if(resultados[i] > misPuntos){
							mensaje = "HAS PERDIDO";
							continue;
						}
						else if(resultados[i] ==  misPuntos){
							mensaje = "NO HAY GANADOR";
						}
					}
				}
				
				mensaje_fin.innerHTML = mensaje + "<br><br>Tu puntuación es " + misPuntos + " puntos<br><br><br><br><div class='boton' onclick='resetBrisca()'>Volver a jugar</div><br>"+
				"<a class='boton' href='/'>Ir al home</a><br>";
			}
				
			function seteaPuntos(id, puntos){
				document.getElementById(id+'N').innerHTML = "Puntos: "+puntos;
			}
			
			function resetBrisca(){
				document.getElementById("contenedor_vscpu").style.display = "";
				document.getElementById("contenedor").style.display = "none";
				document.getElementById("mensaje_fin").className = "off";
			}
			
			
			// http://andylangton.co.uk/blog/development/get-viewport-size-width-and-height-javascript
			function viewport(){
				var e = window
				, a = 'inner';
				if ( !( 'innerWidth' in window ) )
				{
				a = 'client';
				e = document.documentElement || document.body;
				}
				return { width : e[ a+'Width' ] , height : e[ a+'Height' ] }
			}

			

		</script>
	</body>
</html>